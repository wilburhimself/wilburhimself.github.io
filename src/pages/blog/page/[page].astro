---
import { getCollection } from 'astro:content';
import BlogLayout from '../../../layouts/BlogLayout.astro';

export async function getStaticPaths() {
  const allPosts = (await getCollection('blog')).sort((a, b) => {
    const dateA = new Date(a.data.date);
    const dateB = new Date(b.data.date);
    return dateB.getTime() - dateA.getTime();
  });
  
  const POSTS_PER_PAGE = 10;
  const totalPages = Math.ceil(allPosts.length / POSTS_PER_PAGE);
  
  return Array.from({ length: totalPages }, (_, i) => i + 1).map((page) => ({
    params: { page: page.toString() },
  }));
}

const { page: pageParam } = Astro.params;
const page = parseInt(pageParam);

const allPosts = (await getCollection('blog')).sort((a, b) => {
  const dateA = new Date(a.data.date);
  const dateB = new Date(b.data.date);
  return dateB.getTime() - dateA.getTime();
});

const POSTS_PER_PAGE = 10;
const totalPages = Math.ceil(allPosts.length / POSTS_PER_PAGE);

// Redirect page 1 to the main blog index
if (page === 1) {
  Astro.response.status = 301;
  Astro.response.headers.set('Location', '/');
}

const posts = allPosts.slice(
  (page - 1) * POSTS_PER_PAGE,
  page * POSTS_PER_PAGE
);
---

<BlogLayout title={`Articles - Page ${page}`}>
  <div class="mb-10">
    <h1 class="text-3xl font-bold">Articles</h1>
    <p class="text-gray-medium text-sm">Long-form writing on software engineering, systems design, and building things.</p>
  </div>
  
  <div class="articles space-y-12">
    {
      posts.map((post) => (
        <article class="article-card group">
          <a href={`/blog/${post.slug}/`} class="block hover:no-underline">
            <div class="flex items-center gap-3 text-sm text-gray-medium mb-0">
              <p class="mb-0">{post.data.date}</p>
              {post.data.tags && (
                <div class="flex gap-2">
                  {post.data.tags.map((tag) => (
                    <a href={`/blog/tags/${tag}`} class="text-gray-500 hover:text-gray-700 no-underline">#{tag}</a>
                  ))}
                </div>
              )}
            </div>
            <h2 class="text-xl font-semibold text-near-black group-hover:text-gray-700 transition-colors mt-0">
              {post.data.title}
            </h2>
            
            <p class="text-gray-600 leading-relaxed">{post.data.excerpt || 'Read more...'}</p>
            <span class="hidden inline-block mt-3 text-sm text-gray-500 group-hover:text-gray-700 transition-colors">
              Read article →
            </span>
          </a>
        </article>
      ))
    }
  </div>
  
  <!-- Pagination -->
  <div class="pagination flex justify-between items-center mt-16">
    {page > 1 && (
      <a href={page === 2 ? '/' : `/blog/page/${page - 1}/`} class="text-gray-dark hover:text-near-black">
        ← Previous
      </a>
    )}
    {page === 1 && <span></span>}
    
    <div class="pagination-links">
      {
        Array.from({ length: totalPages }, (_, i) => i + 1).map((pageNum) => (
          <a 
            href={pageNum === 1 ? '/' : `/blog/page/${pageNum}/`} 
            class={`px-3 py-1 mx-1 rounded ${pageNum === page ? 'bg-gray-200 font-bold' : 'hover:bg-gray-100'}`}
          >
            {pageNum}
          </a>
        ))
      }
    </div>
    
    {page < totalPages && (
      <a href={`/blog/page/${page + 1}/`} class="text-gray-dark hover:text-near-black">
        Next →
      </a>
    )}
    {page === totalPages && <span></span>}
  </div>
</BlogLayout>